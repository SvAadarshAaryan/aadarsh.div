<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>3D Audio Reactive Dots</title>
<style>
html, body {
    margin: 0;
    padding: 0;
    background: #000;
    overflow: hidden;
    touch-action: none;
}
canvas {
    display: block;
}
.hint {
    position: fixed;
    bottom: 10px;
    left: 50%;
    transform: translateX(-50%);
    color: #aaa;
    font-family: system-ui, sans-serif;
    font-size: 12px;
    opacity: 0.7;
}
</style>
</head>
<body>

<canvas id="canvas"></canvas>
<div class="hint">Tap / Click to activate audio • Move mouse / finger</div>

<script>
/* =========================
   CANVAS SETUP
========================= */
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

function resize() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
}
resize();
window.addEventListener("resize", resize);

/* =========================
   INPUT (MOUSE / TOUCH)
========================= */
let mx = window.innerWidth / 2;
let my = window.innerHeight / 2;

window.addEventListener("mousemove", e => {
    mx = e.clientX;
    my = e.clientY;
});

window.addEventListener("touchmove", e => {
    mx = e.touches[0].clientX;
    my = e.touches[0].clientY;
}, { passive: true });

/* =========================
   AUDIO (SAFE INIT)
========================= */
let audioCtx = null;
let analyser = null;
let data = null;

async function initAudio() {
    if (audioCtx) return;

    audioCtx = new AudioContext();
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    const source = audioCtx.createMediaStreamSource(stream);

    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 512;
    data = new Uint8Array(analyser.frequencyBinCount);

    source.connect(analyser);
}

window.addEventListener("click", initAudio);
window.addEventListener("touchstart", initAudio);

/* =========================
   COLOR (HSV → RGB)
========================= */
function hsv(h, s, v, a = 1) {
    let f = (n, k = (n + h / 60) % 6) =>
        v - v * s * Math.max(Math.min(k, 4 - k, 1), 0);
    return `rgba(${f(5)*255},${f(3)*255},${f(1)*255},${a})`;
}

/* =========================
   DOT SYSTEM (3D SPACE)
========================= */
const DOTS = 5000;
const dots = [];

for (let i = 0; i < DOTS; i++) {
    dots.push({
        x: (Math.random() - 0.5) * 2,
        y: (Math.random() - 0.5) * 2,
        z: Math.random() * 2,
        angle: Math.random() * Math.PI * 2,
        speed: 0.001 + Math.random() * 0.004,
        size: 0.5 + Math.random() * 1.5
    });
}

/* =========================
   ANIMATION LOOP
========================= */
let t = 0;

function animate() {
    t += 0.01;

    // Fading background
    ctx.fillStyle = "rgba(0,0,0,0.2)";
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // Audio energy
    let audioEnergy = 0;
    if (analyser && data) {
        analyser.getByteFrequencyData(data);
        for (let i = 0; i < data.length; i++) {
            audioEnergy += data[i];
        }
        audioEnergy /= data.length * 255;
    }

    const cx = canvas.width / 2;
    const cy = canvas.height / 2;

    for (let d of dots) {
        d.angle += d.speed * (1 + audioEnergy * 3);

        // Rotate in 3D
        const cos = Math.cos(t * 0.3);
        const sin = Math.sin(t * 0.3);

        const x3 = d.x * cos - d.z * sin;
        const z3 = d.x * sin + d.z * cos;

        // Perspective projection
        const depth = 1 / (1 + z3 * 1.5);
        const px = cx + x3 * depth * canvas.width * 0.4;
        const py = cy + d.y * depth * canvas.height * 0.4;

        // Mouse attraction
        const dx = px - mx;
        const dy = py - my;
        const dist = Math.sqrt(dx*dx + dy*dy) + 0.001;
        const pull = Math.min(100 / dist, 2);

        // Radius (SAFE)
        const radius = Math.max(
            0.1,
            d.size * Math.abs(depth) * (1 + audioEnergy * 2)
        );

        const hue = (t * 80 + d.z * 180) % 360;

        ctx.beginPath();
        ctx.fillStyle = hsv(hue, 0.9, 1, depth + audioEnergy);
        ctx.arc(
            px - dx * pull * 0.01,
            py - dy * pull * 0.01,
            radius,
            0,
            Math.PI * 2
        );
        ctx.fill();
    }

    requestAnimationFrame(animate);
}

animate();
</script>

</body>
</html>
